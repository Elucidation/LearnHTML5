<!DOCTYPE html>
<html>
    <head>
        <title>Learning HTML5</title>

        <style>
            body {
                padding: 10px;
                text-align: left;
            }
            canvas {
                border: 1px solid;
                position: relative;
            }
        </style>
        <script type="text/javascript"> <!--
            var cxt;
            var canvasThing; 
            var circlePosField, posField, extraInfo;
            var intID;
            var cx,cy, cradius; // Circle Position
            var x,y,dx,dy; // Position & keypress change speed
            var zoom,dzoom;
            var WIDTH,HEIGHT;
            var ship;
            var timer = 0;
            var DT = 1.0/35;
            
            function init() {
                // Canvas
                canvasThing = document.getElementById("theCanvas");
                cxt = canvasThing.getContext("2d");
                WIDTH = canvasThing.width;
                HEIGHT = canvasThing.height;
                // Statistics
                circlePosField = document.getElementById("cpos");
                posField = document.getElementById("pos");
                spaceShipPosField = document.getElementById("spos");
                extraInfo = document.getElementById("extraInfo");
                timeField= document.getElementById("time");
                
                // Init variables
                x = 0;
                y = 0;
                dx = dy = 5
                zoom=1.0;
                dzoom = 2; // Multiple
                window.onkeydown = doKeyDown;
                
                ship = {x:x,y:y, radius:2,
                        vx: 0, vy: 0,
                        speed: 1}
                
                // Draw planet // Assuming 1m = 1 pixel?
                cradius = 6800000; // 6,800km if 1pixel = 1m
                cx = 300;
                cy = 250+cradius;
                drawPlanet();
                
                update();
                intID = setInterval(update, (DT) * 1000);
                //setInterval(refresh,(DT)*1000);
            }
            
            
            function update() {
              move();
           
              timer+=DT;
              
              refresh();
            }
            
            function move() {
              ship.x += ship.vx*DT;
              ship.y += ship.vy*DT;
              
              // Collision Detect
              var p = {x:cx,y:cy,radius:cradius};
              if (checkCollide(ship,p)) {
                alert("collide");
                resetSpaceShip();
              }
            }
            function checkCollide(cA,cB){
              var dx = cB.x-cA.x;
              var dy = cB.y-cA.y;
              var d = Math.sqrt(dx*dx+dy*dy);
              if (d - cA.radius - cB.radius <= 0) {
                return true;
              }
              else {
                return false;
              }
            }
            
            function refresh() {
              clearUp();
              drawOrigin();
              drawPlanet();
              drawShip()
              updateStatistics();
            }   
            function resetSpaceShip() {
              ship.x = ship.y = ship.vx = ship.vy = 0;
            }
            
            function clearUp() {
              // I have lots of transforms right now
              cxt.save();
              cxt.setTransform(1, 0, 0, 1, 0, 0);
              // Will always clear the right space
              cxt.clearRect(0,0,WIDTH,HEIGHT);
              cxt.restore();
              // Still have my old transforms
            }
            function drawPlanet() {
                cxt.strokeStyle = '#00a';
                cxt.lineWidth = 5;
                cxt.fillStyle = '#cad';
                drawCircle(cx,cy,cradius);
            }
            function drawShip() {
              cxt.strokeStyle = '#f00';
              cxt.fillStyle = '#f0f'
              cxt.lineWidth = "1.5";
              drawCircle(ship.x,ship.y,ship.radius)
            }
            
            function drawPoint(x,y) {
                drawCircle(x,y,2);
            }
            function drawOrigin(){
              cxt.strokeStyle = '#00f';
              cxt.fillStyle = '#000'
              cxt.lineWidth = "1";
              drawPoint(0,0)
            }
            
            function drawCircle(x,y,radius) {
                cxt.beginPath();
                cxt.arc(x,y,radius,0,Math.PI*2,true);
                cxt.closePath();
                cxt.stroke();
                cxt.fill();
            }
            
            function doKeyDown(evt){
              switch (evt.keyCode) {
                case 38:  /* Up arrow was pressed */
                      y -= dy;
                  break;
                case 40:  /* Down arrow was pressed */
                      y += dy;
                  break;
                case 37:  /* Left arrow was pressed */
                      x -= dx;
                  break;
                case 39:  /* Right arrow was pressed */
                      x += dx;
                  break;
                case 32:  /* Spacebar pressed */
                      x = y = 0;
                      zoom = 1;
                      timer = 0;
                      resetSpaceShip();
                  break;
                case 87:  /* W was pressed */
                      ship.vy -= ship.speed;
                  break;
                case 83:  /* S was pressed */
                      ship.vy += ship.speed;
                  break;
                case 65:  /* A was pressed */
                      ship.vx -= ship.speed;
                  break;
                case 68:  /* D was pressed */
                      ship.vx += ship.speed;
                  break;
                case 90:  /* Z was pressed */
                      zoom *= dzoom;
                  break;
                case 88:  /* X was pressed */
                  if (zoom / dzoom > 0) {
                      zoom /= dzoom;
                  }
                  break;
                default:
                  extraInfo.innerHTML = "Key pressed: "+evt.keyCode;
                  break;
              }
              cxt.setTransform(1, 0, 0, 1, 0, 0);
              cxt.scale(zoom,zoom);
              cxt.translate(-x,-y);
            }
            
            
            function mouseClick(e)
            {
                var mouseX, mouseY;

                if(e.offsetX) {
                    mouseX = e.offsetX;
                    mouseY = e.offsetY;
                }
                else if(e.layerX) {
                    mouseX = e.layerX;
                    mouseY = e.layerY;
                }
                cxt.strokeStyle = '#f00';
                cxt.fillStyle = '#fff'
                cxt.lineWidth = "1.5";
                drawPoint(mouseX,mouseY);
            }   
            
            function updateStatistics() {
              circlePosField.innerHTML = cx+", "+cy + " r: "+cradius;
              posField.innerHTML = x+", "+y + "     scale:     " + zoom;
              spaceShipPosField.innerHTML = ship.x+", "+ship.y + "   v:   " + ship.vx + ", " + ship.vy;
              timeField.innerHTML = timer
            }
            --></script>
    </head>
    <body onload="init();">
        <h1>So far so good.</h1>
        <p>
            <canvas id="theCanvas"
                    width="600" 
                    height="300" 
                    onclick="mouseClick(event);">
                    Your browser does not support HTML5 Canvas unfortunately.
            </canvas>
        </p>
        <p>Circle Position: <b id="cpos"></b></p>
        <p>Camera Position: <b id="pos"></b></p>
        <p>Spaceship Position: <b id="spos"></b></p>
        <p>Time: <b id="time"></b></p>
        <p>Extra Info: <b id="extraInfo"></b></p>
    </body>
</html>